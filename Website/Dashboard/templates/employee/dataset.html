{% extends '../components/base.html' %}
{% block title %}
Dataset Wajah
{% endblock %}
{% block content %} {% csrf_token %}

<div class="content">
    <div class="container-xl">
      <div class="page-header">
        <div class="row align-items-center">
          <div class="col-auto">
            <div class="page-pretitle">
              Data
            </div>
            <h2 class="page-title">
              {{name}}'s Face Datasets
            </h2>
          </div>
        </div>
      </div>
      <div class="row row-deck row-cards">

            <div class="card">
                <div class="card-body">
                    {%if user.role == 'employee' %}
                    <div class="card-body text-center">
                        <button class="btn btn-primary mt-3" onclick="captureFaces()">Capture Faces</button>
                        <button class="btn btn-primary mt-3" onclick="trainModel()">Train Face Model</button>
                   </div>
             
                   {%endif%}

                    <form id="delete-form" method="post" action="{% url 'delete_images' %}">
                        {% csrf_token %}
                        <div class="mb-3 text-center" id="delete-button-container" style="display: none;">
                            <button type="submit" class="btn btn-danger">Delete Selected</button>
                        </div>
                        <div class="row row-deck row-cards">
                            {% load static %}
                            {% for image in images %}
                            <div class="col-3 col-md-2 col-lg-1 mb-2 text-center">
                                <label>
                                    <input type="checkbox" name="images_to_delete" value="{{ image.url }}" class="image-checkbox" onchange="toggleDeleteButton()">
                                    <img src="{% static image.url %}" alt="Face Image" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </form>
                    

                </div>
            </div>
      </div>
    </div>
</div>

<script>
    captureFaces = () => {
        window.location.href = "{% url 'capture_page' %}";
            }
            function trainModel() {
                // Initialize the progress variables
                let progress = 0; // Progress percentage
                const totalSteps = 100; // Total steps for the progress bar
                const progressInterval = 100; // Interval for updating progress in milliseconds
            
                // Show the SweetAlert with a loading spinner and progress bar
                const swalInstance = Swal.fire({
                    title: 'Training model...',
                    html: `
                        <div id="progress-container" style="width: 100%; height: 30px; background-color: #f3f3f3; border-radius: 5px;">
                            <div id="progress-bar" style="width: 0%; height: 100%; background-color: #4caf50; border-radius: 5px;"></div>
                        </div>
                        <div id="progress-text" style="text-align: center; margin-top: 5px;">Progress: 0%</div>
                    `,
                    allowEscapeKey: false,
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    onBeforeOpen: () => {
                        Swal.showLoading();
                    }
                });
            
                // Start the fetch request to train the model
                fetch("{% url 'train_model' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Simulate progress updates
                        const interval = setInterval(() => {
                            if (progress < totalSteps) {
                                progress++;
                                const progressPercentage = (progress / totalSteps) * 100;
            
                                // Update the progress bar and text
                                document.getElementById('progress-bar').style.width = progressPercentage + '%';
                                document.getElementById('progress-text').innerText = `Progress: ${progressPercentage.toFixed(2)}%`;
                            } else {
                                clearInterval(interval); // Stop the interval when complete
                                Swal.close(); // Close the loading alert
                                // Show success message
                                Swal.fire({
                                    title: 'Success!',
                                    text: data.message,
                                    icon: 'success',
                                    confirmButtonText: 'OK'
                                }).then(() => {
                                    // Redirect to dataset page after closing the alert
                                    window.location.reload()
                                });
                            }
                        }, progressInterval);
                    } else {
                        // Show SweetAlert error message
                        Swal.fire({
                            title: 'Error!',
                            text: data.message,
                            icon: 'error',
                            confirmButtonText: 'Try Again'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        title: 'Error!',
                        text: 'An unexpected error occurred.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                });
            }

            function toggleDeleteButton() {
                const checkboxes = document.querySelectorAll('.image-checkbox');
                const deleteButtonContainer = document.getElementById('delete-button-container');
                let anyChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);
                deleteButtonContainer.style.display = anyChecked ? 'block' : 'none';
            }
</script>
{% endblock %}

