{% extends '../components/base.html' %}
{% block title %}Presence Stream{% endblock %}

{% block content %}
{% csrf_token %}
<div class="content">
  <div class="container-xl">
    <div class="page-header">
      <div class="row align-items-center">
        <div class="col-auto">
          <div class="page-pretitle">{{ company.name }}'s</div>
          <h2 class="page-title">Presence Stream</h2>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="row">
          <!-- Video Feed -->
          <div class="col-md-6 text-center">
            <div id="loader" class="spinner-border text-primary" role="status" style="display: none;">
              <span class="sr-only">Loading...</span>
            </div>
            <img id="img_stream" src="{% url 'capture_video' %}" style="width: 100%; border-radius: 10px;" />
            <div id="alert-box"></div>
          </div>

          <!-- Real-time Table -->
          <div class="col-md-6">
            <h4 class="mb-3">Absen Hari Ini - <span id="today-date"></span></h4>

            <table class="table table-bordered" id="presence-table">
              <thead>
                <tr>
                  <th>Nama</th>
                  <th>Status</th>
          

                </tr>
              </thead>
              <tbody>
                <!-- Data will be injected here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function detectPresence() {
    fetch("{% url 'capture_absence_from_webcam' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({})
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "success") {
        Swal.fire({
          icon: 'success',
          title: data.message,
          showConfirmButton: false,
          timer: 2000
        });
        loadPresenceTable(); // refresh table on success
      } else if (data.status === "info" || data.status === "error") {
        Swal.fire({
          icon: 'info',
          title: data.message,
          showConfirmButton: false,
          timer: 2500
        });
      }
    })
    .catch(err => {
      console.error('Error:', err);
      Swal.fire({
        icon: 'error',
        title: 'Gagal mendeteksi kehadiran.',
        text: 'Terjadi kesalahan pada sistem.',
        showConfirmButton: true
      });
    });
  }
  function loadPresenceTable() {
    fetch("{% url 'get_today_presences' %}")
      .then(res => res.json())
      .then(response => {
        console.log(response);
  
        // Access the array inside the response
        const data = response.data;  // Extract the array from the 'data' key
  
        // Check if the extracted data is an array
        if (Array.isArray(data)) {
          const tbody = document.querySelector('#presence-table tbody');
          tbody.innerHTML = ''; // clear old data
          data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${row.name}</td>
              <td>${row.status}</td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          console.error('Data is not an array:', data);
        }
      })
      .catch(error => {
        console.error('Error fetching presence data:', error);
      });
  }
  
  

  setInterval(detectPresence, 5000);
  setInterval(loadPresenceTable, 5000); // refresh presence table
  window.onload = loadPresenceTable;
  document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
  
    // Format the date in the format YYYY-MM-DD (you can change this to any format you prefer)
    const formattedDate = today.toLocaleDateString('id-ID'); // 'id-ID' for Indonesian locale
    
    // Set the date to the element with ID 'today-date'
    document.getElementById('today-date').textContent = formattedDate;
  });
  
</script>
{% endblock %}

{% comment %} {% extends '../components/base.html' %}
{% block title %}
Presence Stream
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="content">
    <div class="container-xl">
      <div class="page-header">
        <div class="row align-items-center">
          <div class="col-auto">
            <div class="page-pretitle">
              {{ company.name }}'s
            </div>
            <h2 class="page-title">
                Presence Stream
            </h2>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="col-12">
            <div class="card">
                <div class="card-body">

                    <!-- Camera Cards -->
                    <div class="row">
                        {% for cam in presence_cameras %}
                        <div class="col-md-6"> <!-- Change col-md-4 to col-md-6 for 2 columns -->
                            
                            <div class="card mb-3 text-center">
                                <div class="card-body flex">
                                    <h5 class="card-title mr-2">{{ cam.cam_name }}</h5>
                                    <!-- Status Badge -->
                                    {% if cam.cam_is_active %}
                                        <span class="badge bg-success">Active</span>
                                    {% else %}
                                        <span class="badge bg-danger">Inactive</span>
                                    {% endif %}

                                    <!-- Start and Stop Buttons -->
                                    <div class="mb-3">
                                        {% if cam.cam_is_active %}
                                            <a href="{% url 'stop_presence_stream' cam.id %}">
                                                <button class="btn btn-danger stop-stream" onclick="toggleStream('stop', {{ cam.id }})">Stop Stream</button>
                                            </a>
                                        {% else %}
                                            <a href="{% url 'start_presence_stream' cam.id %}">
                                                <button class="btn btn-primary start-stream" onclick="toggleStream('start', {{ cam.id }})">Start Stream</button>
                                            </a>
                                        {% endif %}
                                    </div>

                                    <div id="loader" class="spinner-border text-primary" role="status" style="display: none;">
                                        <span class="sr-only">Loading...</span>
                                    </div>

                                    <!-- Video Stream -->
                                    <img id="img_stream_{{ cam.id }}" src="{% url 'predict_video' cam.id %}" style="width: 100%; border-radius: 10px; display: {% if cam.cam_is_active %}block{% else %}none{% endif %};" />
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <p>No cameras available.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>

<script>
    function updateStream() {
        const cameraSelect = document.getElementById('cameraSelect');
        const selectedCamId = cameraSelect.value;
        const imgStream = document.getElementById('img_stream');

        imgStream.src = `{% url 'predict_video' 0 %}`.replace('0', selectedCamId);
        imgStream.style.display = 'block'; // Show the image
    }
    function toggleStream(action, camId) {
      const loader = document.getElementById(`loader_${camId}`);
      const imgStream = document.getElementById(`img_stream_${camId}`);
  
      if (action === 'start') {
          // Show the loader
          loader.style.display = 'block';
          imgStream.style.display = 'none'; // Hide the stream image while loading
  
          // Simulate an AJAX call to start the stream
          setTimeout(() => {
              // After the stream is started, hide the loader and show the stream image
              loader.style.display = 'none';
              imgStream.style.display = 'block'; // Show the stream image
          }, 2000); // Simulate a delay for starting the stream
      } else if (action === 'stop') {
          // Handle stopping the stream (if needed)
          imgStream.style.display = 'none'; // Hide the stream image
      }
  }
</script>

{% endblock %} {% endcomment %}