{% extends '../components/base.html' %}
{% block title %}Dashboard Admin{% endblock %}

{% block content %}
{% csrf_token %}
<div class="content">
  <div class="container-xl">
    <!-- Page title -->
    <div class="page-header">
      <div class="row align-items-center">
        <div class="col-auto">
          <div class="page-pretitle">Overview</div>
          <h2 class="page-title">Dashboard</h2>
        </div>
      </div>
    </div>

    <div class="row row-deck row-cards">
      <!-- Bar Chart -->
      <div class="col-sm-7">
        <div class="card">
          <div class="card-header border-0">
            <h3 class="card-title">Employee Stats</h3>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <div style="max-width: 250px;" class="mr-2">
                <div class="input-icon">
                  <input id="calendar-range" type="date" class="form-control" placeholder="Select a date range" />
                </div>
              </div>
            </div>
            <div id="chart-bar"></div>
          </div>
        </div>
      </div>

      <!-- Donut Chart -->
      <div class="col-sm-5">
        <div class="card">
          <div class="card-header border-0">
            <h3 class="card-title">Today Employee Stats</h3>
          </div>
          <div class="card-body">
            <div id="chart-donut"></div>
          </div>
        </div>
      </div>

      <!-- Top Employee Table -->
      <div class="col-12 p-2">
        <div class="card">
          <div class="card-header border-0">
            <h3 class="card-title">Top Employee</h3>
          </div>
          <div class="card-body">
            <div class="d-flex mb-3">
              <div style="max-width: 200px;" class="mr-2">
                <label for="month-select" class="form-label">Month</label>
                <select id="month-select" name="month" class="form-select"></select>
              </div>
              <div style="max-width: 200px;" class="mr-2">
                <label for="year-select" class="form-label">Year</label>
                <select id="year-select" name="year" class="form-select"></select>
              </div>
              <div style="max-width: 200px;" class="mr-2">
                <label for="performance-select" class="form-label">Performance</label>
                <select id="performance-select" name="performance" class="form-select">
                  <option value="ontime" selected>Most On Time</option>
                  <option value="late">Most Late</option>
                  <option value="hardworking">Hardest Worker</option>
                </select>
              </div>
            </div>
            <div class="table-responsive w-100">
              <table class="table card-table table-vcenter text-nowrap datatable">
                <thead>
                  <tr>
                    <th class="w-1">No.</th>
                    <th>ID Employee</th>
                    <th>Nama Employee</th>
                    <th>Divisi</th>
                    <th>Total Ontime</th>
                  </tr>
                </thead>
                <tbody>
                  {% for employee in top_employees %}
                  <tr>
                    <td>{{ forloop.counter }}</td>
                    <td><span class="text-muted">{{ employee.employee_id }}</span></td>
                    <td>{{ employee.name }}</td>
                    <td>{{ employee.division }}</td>
                    <td>{{ employee.total_ontime }}</td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="5" class="text-center">No top employees found.</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- JS Dependencies -->
<script src="../dist/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="../dist/libs/jquery/dist/jquery.slim.min.js"></script>
<script src="../dist/libs/apexcharts/dist/apexcharts.min.js"></script>
<script src="../dist/libs/flatpickr/dist/flatpickr.min.js"></script>
<script src="../dist/js/tabler.min.js"></script>

<!-- Chart Scripts -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    flatpickr(document.getElementById('calendar-range'), { mode: "range" });

    // Parse summary from context or fallback
    const summary = {{ summary|default:'{"ontime": 0, "late": 0}'|safe }};

    // Donut Chart
    const donutChart = new ApexCharts(document.getElementById('chart-donut'), {
      chart: {
        type: "donut",
        height: 240,
        animations: { enabled: true },
      },
      series: [summary.ontime || 0, summary.late || 0],
      labels: ["Ontime", "Late"],
      colors: ["#206bc4", "#cd201f"],
      legend: { show: true },
      tooltip: { fillSeriesColor: false },
    });
    donutChart.render();

    // Bar Chart
    const barChart = new ApexCharts(document.getElementById('chart-bar'), {
      chart: {
        type: "bar",
        height: 250,
        stacked: true,
      },
      series: [
        {
          name: "Ontime",
          data: [10, 15, 20, 25, 30]
        },
        {
          name: "Late",
          data: [5, 10, 7, 8, 6]
        }
      ],
      xaxis: {
        categories: ['Alice', 'Bob', 'Charlie', 'David', 'Eve'],
      },
      colors: ["#206bc4", "#cd201f"],
      legend: { show: true },
      tooltip: { shared: true },
    });
    barChart.render();
  });
</script>

<!-- Populate Selects -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');
    const currentYear = new Date().getFullYear();

    const months = [
      'January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'
    ];

    months.forEach((month, i) => {
      const option = document.createElement('option');
      option.value = i + 1;
      option.text = month;
      monthSelect.appendChild(option);
    });

    for (let y = currentYear - 5; y <= currentYear + 5; y++) {
      const option = document.createElement('option');
      option.value = y;
      option.text = y;
      yearSelect.appendChild(option);
    }
  });
</script>
{% endblock %}
